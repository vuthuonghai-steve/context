### Bảng đánh giá thiết kế các bảng

Dưới đây là bảng đánh giá, nhóm theo module để dễ đọc. Mỗi hàng đánh giá một nhóm/bảng chính, với cột:
- **Bảng/Module**: Tên.
- **Tính chặt chẽ (Integrity)**: Điểm 1-10, lý do + ví dụ.
- **Thống nhất (Consistency)**: Điểm 1-10, so sánh với quy ước chung.
- **Mối quan hệ (Relationships)**: Loại + chất lượng.
- **Tối ưu hiệu năng (Performance)**: Gợi ý indexes/trigger.
- **Gợi ý cải thiện**: Cụ thể, thực tế.

| Bảng/Module | Tính chặt chẽ (Integrity) | Thống nhất (Consistency) | Mối quan hệ (Relationships) | Tối ưu hiệu năng (Performance) | Gợi ý cải thiện |
|-------------|---------------------------|---------------------------|-----------------------------|--------------------------------|-----------------|
| **1-3: Brands, Categories, Products** (Sản phẩm cốt lõi) | 9/10: CHECK sale_price <= price tốt; UNIQUE slug tránh duplicate. Ví dụ: Ngăn slug trùng cho lò vi sóng Panasonic. | 9/10: DECIMAL(12,2) thống nhất cho price; BOOLEAN defaults rõ. | 1:N (brands→products, categories→products RESTRICT); Hierarchical (categories.parent_id SET NULL). Tốt, không orphan records. | Indexes: products(slug, category_id, brand_id). Trigger: Update product_stats.total_sold khi sell. | Thêm is_featured BOOLEAN cho homepage; ENUM cho energy_rating (A++...G) thay TINYINT để validate. |
| **4-6: Inventories, Inventory_movements, Product_stats** (Quản lý kho & Stats) | 8/10: UNSIGNED cho quantity tránh âm; ENUM type chặt. Ví dụ: 'sell' movement trừ stock_on_hand realtime. | 8/10: FK product_id nhất quán; Nhưng timestamps chỉ created_at ở movements (thiếu updated_at?). | 1:N (products→inventories PK, →movements); Stats là denormalized view (tổng hợp). | Indexes: movements(product_id, type, created_at); Partition movements by created_at cho log lớn. | Thêm trigger tự động: Khi order 'delivered', insert 'out' movement + update stats.total_sold. Xem xét low_stock threshold INT. |
| **7-8: Users, Addresses** (Người dùng) | 9/10: UNIQUE email; TIMESTAMP email_verified_at cho verification. | 10/10: role ENUM chuẩn; country_code default 'VN' phù hợp VN. | 1:N (users→addresses); is_default BOOLEAN cho billing address. | Indexes: users(email); addresses(user_id, is_default). | Thêm phone_verified_at; JSON cho extra_fields nếu cần (nhưng tránh overuse JSON). |
| **9-10: Orders, Order_items** (Đơn hàng) | 9/10: ENUM status/payment chặt; Snapshot name/price tránh thay đổi. Ví dụ: Giá lò vi sóng lúc đặt != hiện tại. | 9/10: DECIMAL thống nhất; Timestamps riêng (placed_at...) linh hoạt. | 1:N (users→orders→items); FK shipping_address_id. | Indexes: orders(user_id, status, created_at); items(order_id). | Trigger: Tính grand_total = subtotal + shipping - discount tự động. Thêm coupon_code VARCHAR ở orders cho voucher. |
| **11: Reviews** (Đánh giá) | 8/10: UNIQUE order_item_id (1 review/item); TINYINT 1-5 CHECK ngầm. | 8/10: FK đầy đủ (order_item, user, product). | 1:1 (order_item→review); 1:N (product→reviews). | Indexes: reviews(product_id, created_at DESC) cho top reviews. | Thêm is_verified BOOLEAN (chỉ review sản phẩm đã mua); Trigger update product_stats.average_rating khi insert. |
| **12-13: Carts, Cart_items** (Giỏ hàng) | 8/10: ENUM status ('active'...'abandoned') theo dõi hành vi. | 9/10: Snapshot price như orders. | 1:N (users→carts→items). | Indexes: carts(user_id, status); items(cart_id). Cron job: Update 'abandoned' sau 24h. | Thêm expires_at TIMESTAMP cho session-based cart (nếu guest user). |
| **14: Payments** (Thanh toán cơ bản) | 7/10: ENUM provider/status; UNIQUE order_id. Nhưng thiếu raw data cho audit. | 8/10: DECIMAL amount khớp orders.grand_total. | 1:1 (orders→payments). | Indexes: payments(order_id, status). | Mở rộng sang module 22 cho gateways đầy đủ; Thêm webhook integration. |
| **15-16: Vouchers, Voucher_usages** (Voucher) | 9/10: UNIQUE code UPPERCASE; CHECK value 0-100 cho PERCENT. Ví dụ: Voucher 10% cho lò vi sóng >1tr. | 9/10: ENUM type; Indexes khuyến nghị tốt. | 1:N (vouchers→usages); N:1 (users/orders). | Indexes: vouchers(code, is_active, start_at); usages(voucher_id, user_id, status). | Trigger: Tăng used_count khi 'consumed'; Validate min_order_total ở app layer. |
| **17: Sales** (Khuyến mãi) | 7/10: ENUM scope; JSON payload linh hoạt. | 7/10: JSON có thể dư thừa nếu scope=PRODUCT (danh sách id dài). | Không FK trực tiếp (payload JSON ref ids). | Indexes: sales(start_at, end_at, is_active). | Chuyển payload thành bảng riêng (sales_products pivot) cho query nhanh; Trigger apply discount ở orders. |
| **18: Loyalty (Tiers, Accounts, Transactions)** (Điểm thưởng) | 8/10: ENUM type; +/- points rõ. Ví dụ: Earn 1% grand_total khi mua lò vi sóng. | 8/10: JSON benefits linh hoạt. | 1:N (users→accounts/transactions); 1:1 (accounts→tier). | Indexes: transactions(user_id, type, created_at); accounts(tier_id). | Trigger: Update tier khi points_balance >= min_points; Expire points hàng tháng. |
| **19: Wishlists, Wishlist_items** (Yêu thích) | 9/10: Composite UNIQUE tránh trùng. | 9/10: Đơn giản, khớp carts. | 1:N (users→wishlists→items). | Indexes: items(wishlist_id, product_id). | Thêm notify_when_stock BOOLEAN cho low-stock alert. |
| **20: Carriers, Shipments, Shipment_events** (Vận chuyển) | 9/10: ENUM status; JSON raw_payload cho GHN callback. Ví dụ: Tracking code từ GHTK. | 9/10: FK order_id UNIQUE; Indexes tốt. | 1:1 (orders→shipments→events); 1:N (carriers→shipments). | Indexes: shipments(carrier_id, status); events(shipment_id, occurred_at). Webhook trigger insert events. | Thêm estimated_weight DECIMAL ở shipments cho fee calc; Integrate API real-time status. |
| **21: Webhooks, Webhook_logs** (Callback) | 8/10: secret_hash cho HMAC verify; Idempotency request_id. | 8/10: JSON payload an toàn. | 1:N (webhooks→logs). | Indexes: logs(webhook_id, status, received_at). | Retry queue cho failed logs; ENUM provider khớp carriers. |
| **22: Payment_transactions** (Thanh toán mở rộng) | 8/10: ENUM gateway/status; UNIQUE txn_ref. | 8/10: JSON raw_request/response cho debug. | 1:N (payments→transactions). | Indexes: transactions(gateway, status, created_at); UNIQUE(txn_ref, gateway). | Trigger update payments.status khi 'succeeded'; Support refund flow. |
| **23: Refunds, Refund_items, Refund_events** (Hoàn tiền) | 9/10: ENUM status; <=7 ngày ngầm qua app. Ví dụ: Refund partial lò vi sóng lỗi. | 9/10: FK đầy đủ; Composite indexes. | 1:N (orders→refunds→items/events); 1:1 (payments). | Indexes: refunds(order_id); items(refund_id, order_item_id). | Trigger: Update inventory + loyalty khi completed; Limit amount <= paid. |
| **24: Pages, Posts, Categories/Tags** (CMS) | 8/10: UNIQUE slug; JSON meta cho SEO. | 8/10: Pivot tables cho N:N (post_category_post). | 1:N (users→posts); N:N (posts↔categories/tags). | Indexes: posts(is_published, published_at); Pivot composites. | Thêm featured_image VARCHAR; Slug auto-generate từ title. |
| **25: Notification_templates, Notification_logs** (Thông báo) | 8/10: ENUM channel/status; Snapshot body. | 8/10: key UNIQUE cho template reuse. | 1:N (templates→logs); Optional user_id. | Indexes: logs(channel, status, sent_at). Queue system cho 'queued'. | Integrate với email/SMS API; Personalize body với placeholders (e.g., {product_name}). |
| **26: Tickets, Messages, Attachments** (Hỗ trợ) | 9/10: ENUM status/priority; FK sender_id. | 9/10: LONGTEXT cho message; MIME cho attachments. | 1:N (users→tickets→messages→attachments); Optional order_id. | Indexes: tickets(status, priority, created_at); messages(ticket_id). | Auto-assign based on category; Email notify khi new message. |
| **27: User_events, Product_analytics_daily** (Analytics) | 7/10: ENUM event; JSON metadata linh hoạt. | 7/10: Daily aggregate tốt, nhưng events có thể bloat (lớn). | Optional FK user/product/order. | Indexes: events(event, occurred_at), (user_id, occurred_at); UNIQUE(date, product_id) ở daily. Partition events by occurred_at. | ETL job hàng ngày từ events → daily; GDPR compliance cho user data. |
| **28: User_recommendations** (Cá nhân hóa) | 8/10: UNIQUE (user,product); Score DECIMAL validate 0-1. | 8/10: JSON reason cho collab filtering. | 1:N (users→recommendations); FK product. | Indexes: recommendations(user_id, score DESC). | Cron regenerate hàng tuần dựa trên ML model; Expire old recs. |
